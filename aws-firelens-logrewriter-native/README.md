# The project
This is a native version of the upper aws firelens log rewriter.
This project is based on quarkus, and it's guide:
Quarkus guide: https://quarkus.io/guides/spring-web

# Changes?
1. the fastjson, log4j is not available in graalvm when building native image. 
2. some classes which can't use initialize are ignored in [application.properties](src/main/resources/application.properties) 

# Build native image files
``
./mvnw verify -Pnative
``
the native file is under `target/aws-firelens-logrewriter-1.0.0-SNAPSHOT-runner`

# Build docker files
check the docker folder. the docker folder is generated by quarkus plugin:
> The extension quarkus-container-image-docker is using the Docker binary and the generated Dockerfiles under src/main/docker in order to perform Docker builds.
> To use this feature, add the following extension to your project.
./mvnw quarkus:add-extension -Dextensions="container-image-docker"
>

## Build image using graalvm ce version
because you are building the native image, you will need : https://github.com/quarkusio/quarkus-images 
``
docker pull quay.io/quarkus/centos-quarkus-maven:21.1.0-java11
docker run -it -v /Users/ed_freshlime/projects/forked/aws-firelens-logrewriter/aws-firelens-logrewriter-native:/project quay.io/quarkus/centos-quarkus-maven:21.1.0-java11 ./mvnw verify -Pnative
docker build -f src/main/docker/Dockerfile.native -t edwardg/aws-firelens-logrewriter:native-1.0.0-SNAPSHOT .
``

## Build image using graalvm enterprise Version
The enterprise version provided heap dump function. <br>
So I build a docker image which contains the graalvm enterprise version. I use it to check why the memory leaked in this project. <br>
check the [readme.md](docker-build-image/readme.md)
``
docker run -it -v /Users/ed_freshlime/projects/forked/aws-firelens-logrewriter/aws-firelens-logrewriter-native:/project edwardg/graalvm:graalvm-ee-java11-linux-amd64-21.2.0.1 ./mvnw verify -Pnative
``

# how to use
``
docker run -e LOKI_HOST=xxx.com -e LOKI_PORT=3100  -p 8080:8080 edwardg/aws-firelens-logrewriter:native-1.0.0-SNAPSHOT
``
``
docker push edwardg/aws-firelens-logrewriter:native-1.0.0-SNAPSHOT
``


# Comparison between native version and not.
1. The memory is lower 3/4. The previous is about 800M (about 15 logs components, each has a 16MB buffer). now it's about 500MB.
2. The file size decreased from 100MB to 21MB. (it can be improved more...)

# References
1. [a simple guide of quarkus about how to build native image](https://quarkus.io/guides/building-native-image)
2. [use quarkus to build docker image](https://quarkus.io/guides/container-image)
3. [create heap dump](https://www.graalvm.org/reference-manual/native-image/NativeImageHeapdump/) 


